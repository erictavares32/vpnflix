<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Availability Checker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .search-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        input, select, button {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        input {
            width: 60%;
        }
        select {
            width: 30%;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        #results {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .streaming-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .streaming-option:last-child {
            border-bottom: none;
        }
        .provider-logo {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            object-fit: contain;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .error {
            color: #d32f2f;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <h1>Where to Watch</h1>
        <input type="text" id="searchQuery" placeholder="Enter movie or TV show title">
        <select id="countrySelect">
            <option value="US">United States</option>
            <option value="GB">United Kingdom</option>
            <option value="CA">Canada</option>
            <option value="AU">Australia</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="JP">Japan</option>
            <option value="IN">India</option>
            <option value="BR">Brazil</option>
            <!-- Add more countries as needed -->
        </select>
        <button onclick="searchContent()">Search Availability</button>
    </div>
    
    <div id="results"></div>

    <script>
        async function searchContent() {
            const query = document.getElementById('searchQuery').value.trim();
            const country = document.getElementById('countrySelect').value;
            const resultsDiv = document.getElementById('results');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="error">Please enter a title to search</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">Searching... <div class="spinner"></div></div>';
            
            try {
                // First search for the title to get its ID
                const searchResponse = await fetch(`https://apis.justwatch.com/content/titles/${country}/popular`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        content_types: ["movie", "show"],
                        page_size: 5
                    })
                });
                
                const searchData = await searchResponse.json();
                
                if (!searchData.items || searchData.items.length === 0) {
                    resultsDiv.innerHTML = '<div class="error">No results found for your search</div>';
                    return;
                }
                
                // Display search results and let user select one
                let html = '<h2>Select the correct title:</h2>';
                searchData.items.forEach(item => {
                    const year = item.original_release_year || 'N/A';
                    const type = item.object_type === 'movie' ? 'Movie' : 'TV Show';
                    html += `
                        <div class="streaming-option" onclick="getOffers('${item.id}', '${item.title}', '${country}')">
                            <strong>${item.title}</strong> (${year}) - ${type}
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Error:', error);
            }
        }
        
        async function getOffers(titleId, titleName, country) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Checking availability...</div>';
            
            try {
                // Get streaming offers for the selected title
                const offersResponse = await fetch(`https://apis.justwatch.com/content/titles/${titleId}/locale/${country}`);
                const offersData = await offersResponse.json();
                
                let html = `<h2>${titleName} - Streaming Options in ${country}</h2>`;
                
                if (offersData.offers && offersData.offers.length > 0) {
                    // Group by streaming type (buy/rent/subscription)
                    const groupedOffers = {
                        subscription: [],
                        buy: [],
                        rent: [],
                        free: [],
                        ads: []
                    };
                    
                    offersData.offers.forEach(offer => {
                        const type = offer.monetization_type;
                        if (groupedOffers[type]) {
                            groupedOffers[type].push(offer);
                        }
                    });
                    
                    // Display each category
                    for (const [type, offers] of Object.entries(groupedOffers)) {
                        if (offers.length > 0) {
                            const typeName = {
                                subscription: 'Subscription',
                                buy: 'Purchase',
                                rent: 'Rental',
                                free: 'Free',
                                ads: 'With Ads'
                            }[type] || type;
                            
                            html += `<h3>${typeName}</h3>`;
                            
                            offers.forEach(offer => {
                                const price = offer.retail_price ? `${offer.currency} ${offer.retail_price}` : 'Included';
                                html += `
                                    <div class="streaming-option">
                                        <img src="https://images.justwatch.com${offer.provider_logo}" alt="${offer.package_short_name}" class="provider-logo">
                                        <div>
                                            <strong>${offer.package_short_name.toUpperCase()}</strong><br>
                                            ${price} | ${offer.presentation_type || 'Unknown quality'}
                                        </div>
                                        <a href="${offer.urls.standard_web}" target="_blank" style="margin-left: auto;">View</a>
                                    </div>
                                `;
                            });
                        }
                    }
                } else {
                    html += '<p>No streaming options found for this title in your selected country.</p>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>